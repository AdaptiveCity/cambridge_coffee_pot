# Raspberry Pi with second WiFi interface as an Access Point

## Objective

We want to collect data from nearby Wifi-connected sensors via a local Access Point / SSID, while also
providing data backhaul for those sensors plus any local sensors connected to the Pi over another WiFi connection.

*Note for our purposes we are not configuring the Pi to route traffic from the Access Point onwards to the internet, but
the final section of this Readme provides pointers for one additional step if this is what you want to do.*

## Outline method

During the initial setup phase you might have the Pi connected to the internet via the wired ethernet interface, or
ensure you have a keyboard and screen locally connected and download any files needed before you start.

We will configure the **built-in** wlan0 WiFi interface to operate as an Access point and DHCP server with the Pi on address
192.168.75.1 and serving IP DHCP addresses in the range 192.168.75.100-200. We'll also set up the Pi to serve the *time*
via NTP to this WiFi subnet.

We will install a *second* WiFi interface (an inexpensive USB WiFi Dongle) to configure as the new client connecting
the Pi to your usual WiFi network, replacing the function of the original wlan0. We are configuring the two WiFi
interfaces this way round because it has much better software support and configuring *master* or *AP*-mode WiFi
support is a minefield of software and chipset capabilities.

Our example use case is for sensors 'downstream' of the Raspberry Pi to send their data to the Pi.

## Resulting configuration

Our example below assumes the following chosen settings, which can be adjusted as required.
```
AP interface: wlan0
AP wifi ssid: csn-node-test
AP wifi password: csn-node-test
AP wifi channel: 7
AP IP subnet: 192.168.75.0/24
Pi address on AP subnet: 192.168.75.1
```

The subnet can easily be tested by connecting a laptop to the `csn-node-test` WiFi SSID, confirming an IP
address is assigned in the range 192.168.75.100-200, and that the `192.168.75.1` address is pingable.

# Creating the Access Point

## dhcpcd.conf

You need to edit `/etc/dhcpcd.conf` and add an entry for `wlan0` at the end of the file
as below, note that it sets the IP address for the interface as `192.168.75.1`:

```
# We'll add these later when we add the USB wifi dongle
#interface wlan1
#noipv6 

interface wlan0
static ip_address=192.168.75.1/24
noipv6
nohook wpa_supplicant
```

## hostapd

hostapd is the Linux access point software.

```
sudo apt install hostapd
```

Edit `/etc/hostapd/hostapd.conf` to contain the following, note that is sets ssid and wifi password to `csn-node-test`:

```
# Raspberry Pi Access Point
#
interface=wlan0

country_code=GB

#driver=nl80211
ssid=csn-node-test
hw_mode=g
channel=7
wmm_enabled=0

# Mac-address authentication = accept all (unless deny)
macaddr_acl=0

# Shared key authentication (WEP)
auth_algs=1

# Disable "require stations to know SSID"
ignore_broadcast_ssid=0

wpa=2
wpa_passphrase=csn-node-test
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP CCMP
rsn_pairwise=CCMP
logger_syslog=-1

wpa=2
wpa_passphrase=csn-node-test
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP CCMP
rsn_pairwise=CCMP
logger_syslog=-1
```

## Serving DHCP IP addresses via the Access Point using dnsmasq

dnsmasq is the Linux dhcp and dns server. In the example below it is serving the addresses 192.168.75.100 to 200 with
a lease time of 24 hours. Note also it is giving clients the NTP server address of 192.168.75.1 (i.e. the Pi).

`sudo apt install dnsmasq`

Edit `/etc/dnsmasq.conf` to contain:

```
no-resolv

# we will add this later for the second (optional) wifi interface
#except-interface=wlan1 

interface=wlan0
dhcp-range=192.168.75.100,192.168.75.200,255.255.255.0,24h
log-facility=/var/log/dnsmasq.log
log-queries
port=0
dhcp-option=option:ntp-server,192.168.75.1
```

## Serving NTP via Access Point

NTP is the Linux time server. You can configure this to provide time signals to the subnet served by the Access Point.

Add settings to serve the AP subnet in `/etc/ntp.conf` as the last lines here, so that it serves the time onto only
the subnet (192.168.75.0/24) generated by the Raspberry Pi Access Point.

```
# Added for CSN NODE support
restrict 192.168.75.0 mask 255.255.255.0 nomodify notrap nopeer
broadcast 192.168.75.255
```

# USB Wifi Adapter install

The first step is to install the secondary WiFi adapter.

The command `lsusb` should show the device, e.g. as in the top line here:

```
Bus 001 Device 004: ID 2357:0109 TP-Link TL WN823N RTL8192EU
```

I used a "tp-link 300Mbps Mini Wireless N USB Adapter" TL-WN823N

![tp-link TL-WN823N](tl-wn823n.jpg)

(uses 8192eu driver)

Instructions &  Raspbian drivers at [fars-robotics.net](http://fars-robotics.net) but note
I did **NOT** need to edit my `/etc/interfaces` or `/etc/wpa_supplicant` files.

First step is work out which type of wifi chip is in your USB wifi adapter (by searching
the internet). Eg. in the UK tp-link TL-WN823N it is '8192eu'. Clicking the 
[Directory of available wifi drivers](http://downloads.fars-robotics.net/wifi-drivers/)
gives you a directory-per-driver.

Within the directory (e.g. 
[8192su](http://downloads.fars-robotics.net/wifi-drivers/8192su-drivers/) is the 
long list of available driver versions.

Type `uname -a` to get the version / build number required to select the right file.

Easy install:
```
sudo wget http://fars-robotics.net/install-wifi
sudo chmod +x install-wifi
sudo ./install-wifi
```

At this point you should have a `wlan1` interface.

## dhcpcd.conf

You need to edit `/etc/dhcpcd.conf` and add an entry for `wlan1` at the end of the file
as below:

```
interface wlan1
noipv6 
```

## Ensure dnsmasq doesn't serve DHCP over this interface

Edit `/etc/dnsmasq.conf` to include the `except-interface=wlan1` line, i.e.:

```
no-resolv

except-interface=wlan1

interface=wlan0
dhcp-range=192.168.75.100,192.168.75.200,255.255.255.0,24h
log-facility=/var/log/dnsmasq.log
log-queries
port=0
dhcp-option=option:ntp-server,192.168.75.1
```
# Routing traffic from the AP subnet onwards to the internet.

This is not the subject of this project, but the solution is `iptables` and for clues look here:

https://www.revsys.com/writings/quicktips/nat.html


